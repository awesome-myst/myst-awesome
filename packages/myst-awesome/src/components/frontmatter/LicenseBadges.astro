---
// SPDX-License-Identifier: MIT
// SPDX-FileCopyrightText: 2025 Fideus Labs LLC

/**
 * LicenseBadges component for MyST frontmatter
 * Displays license badges using Creative Commons and other license icons
 * Props:
 * - license: License object or array from frontmatter
 */
import type { Licenses } from '@awesome-myst/myst-zod';

interface Props {
  license?: Licenses;
  iconOnly?: boolean;
}

const { license, iconOnly = false } = Astro.props;

// Extract licenses from the new structure
const allLicenses: any[] = [];
if (license) {
  if (license.content) {
    allLicenses.push({ ...license.content, type: 'content' });
  }
  if (license.code) {
    allLicenses.push({ ...license.code, type: 'code' });
  }
}

// Helper function to get CC icon name from license ID
function getCCIconName(licenseId: string) {
  const ccMatch = /^(CC[^-]*(?:-[A-Z0-9]+)*)/i.exec(licenseId);
  if (!ccMatch) return null;

  const ccType = ccMatch[1].toLowerCase();
  const iconMap: Record<string, string> = {
    'cc-by': 'cc-by',
    'cc-by-4': 'cc-by',
    'cc-nc': 'cc-nc', 
    'cc-nd': 'cc-nd',
    'cc-sa': 'cc-sa',
    'cc-zero': 'cc-zero'
  };
  
  return iconMap[ccType] || null;
}

// Helper function to check if license is Creative Commons
function isCreativeCommons(licenseObj: any) {
  return licenseObj.CC || (licenseObj.id && licenseObj.id.toLowerCase().startsWith('cc'));
}

// Helper function to check if license is OSI approved
function isOSIApproved(licenseObj: any) {
  return licenseObj.osi || licenseObj.OSI;
}
---

{allLicenses && allLicenses.length > 0 && (
  <div style="margin-bottom: var(--wa-space-s);">
    <div style="display: flex; flex-wrap: wrap; gap: var(--wa-space-s);">
      {allLicenses.map((lic: any) => {
        if (!lic) return null;
        
        const licenseUrl = lic.url || (lic.id ? `https://creativecommons.org/licenses/${lic.id.toLowerCase()}/4.0/` : '#');
        const licenseName = lic.name || lic.title || lic.id || 'Unknown License';
        const licenseType = lic.type; // 'content' or 'code'
        
        return (
          <a 
            href={licenseUrl}
            target="_blank"
            rel="noopener noreferrer"
            style={iconOnly 
              ? "display: inline-flex; align-items: center; color: var(--wa-color-neutral-700); text-decoration: none; transition: color 0.2s;"
              : "display: inline-flex; align-items: center; gap: var(--wa-space-xs); padding: var(--wa-space-xs) var(--wa-space-s); background: var(--wa-color-neutral-100); border-radius: var(--wa-border-radius); font-size: var(--wa-font-size-small); text-decoration: none; color: var(--wa-color-neutral-900); transition: background-color 0.2s;"
            }
            title={`${licenseName} (${licenseType} license)`}
            onmouseover={iconOnly 
              ? "this.style.color='var(--wa-color-primary-600)'"
              : "this.style.backgroundColor='var(--wa-color-neutral-200)'"
            }
            onmouseout={iconOnly 
              ? "this.style.color='var(--wa-color-neutral-700)'"
              : "this.style.backgroundColor='var(--wa-color-neutral-100)'"
            }
          >
            {isCreativeCommons(lic) && (
              <wa-icon 
                library="scienceicons" 
                name={'cc'} 
                style="font-size:1rem;" 
              />
            )}
            {isCreativeCommons(lic) && getCCIconName(lic.id) && (
              <wa-icon 
                library="scienceicons" 
                name={getCCIconName(lic.id)} 
                style="font-size:1rem;" 
              />
            )}
            {isOSIApproved(lic) && (
              <wa-icon 
                library="scienceicons" 
                name="osi" 
                style="font-size:1rem; transition: color 0.2s;"
                class="osi-icon"
              />
            )}
            {!iconOnly && <span>{licenseName}</span>}
            {!iconOnly && licenseType && (
              <span style="font-size: var(--wa-font-size-xs); opacity: 0.7; margin-left: var(--wa-space-xs);">
                ({licenseType})
              </span>
            )}
          </a>
        );
      })}
    </div>
  </div>
)}

<style>
  /* OSI green hover effect */
  a:hover .osi-icon {
    color: #4aa94a !important;
  }
</style>
