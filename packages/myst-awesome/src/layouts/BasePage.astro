---
// SPDX-License-Identifier: MIT
// SPDX-FileCopyrightText: 2025 Fideus Labs LLC

interface Props {
  title?: string;
  description?: string;
  theme?: 'default' | 'awesome' | 'shoelace' | 'brutalist' | 'glossy' | 'matter' | 'mellow' | 'playful' | 'premium' | 'tailspin';
  colorScheme?: 'light' | 'dark' | 'auto';
  mobileBreakpoint?: string;
  disableSticky?: string[];
  showNav?: boolean;
  navOpen?: boolean;
}

import { getCollection } from 'astro:content';

// Simple try-catch to avoid warnings if projectFrontmatter collection doesn't exist
let projectConfig: any = null;
try {
  const collection = await getCollection('projectFrontmatter' as any);
  projectConfig = collection?.[0] || null;
} catch {
  // Collection not available - silently continue with defaults
}

const showNavDefault = !!!projectConfig?.data?.options?.hide_toc;

const {
  title = "MyST Awesome Theme",
  description = "A modern documentation theme built with Web Awesome and Astro",
  theme = 'default',
  colorScheme = 'auto',
  mobileBreakpoint = '768px',
  disableSticky = [],
  navOpen = false,
  showNav = showNavDefault
} = Astro.props;

// Determine favicon path and type
let faviconPath = "/favicon.png"; // default fallback
let faviconType = "image/png";

if (projectConfig?.data?.options?.favicon) {
  const projectFaviconPath = projectConfig.data.options.favicon;
  const faviconExtension = projectFaviconPath.split('.').pop()?.toLowerCase();

  // Get the basename for the public URL
  const basename = projectFaviconPath.split('/').pop();
  faviconPath = `/${basename}`;

  // Set the appropriate MIME type
  faviconType = faviconExtension === 'ico' ? 'image/x-icon' :
               faviconExtension === 'png' ? 'image/png' :
               faviconExtension === 'jpg' || faviconExtension === 'jpeg' ? 'image/jpeg' :
               faviconExtension === 'gif' ? 'image/gif' :
               faviconExtension === 'svg' ? 'image/svg+xml' :
               'image/png'; // fallback
}

// Import Themes component for CSS management
import Themes from '../components/Themes.astro';
---

<!doctype html>
<html lang="en" class="wa-cloak">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />

    <!-- Import theme CSS -->
    <Themes themes={['default', 'awesome', 'shoelace']} />

    <link rel="icon" type={faviconType} href={faviconPath} />
    <title>{title}</title>

    <!-- Theme and color scheme initialization -->
    <script>
      // Set initial color scheme before page renders to prevent flashing
      const colorScheme = localStorage.getItem('color-scheme') || 'auto';
      const isDark = colorScheme === 'dark' || (colorScheme === 'auto' && matchMedia('(prefers-color-scheme: dark)').matches);
      document.documentElement.classList.toggle('wa-dark', isDark);

      // Set initial theme
      const savedTheme = localStorage.getItem('theme') || 'default';
      if (savedTheme !== 'default') {
        document.documentElement.classList.add(`wa-theme-${savedTheme}`);
      }
    </script>
  </head>

  <body data-theme={colorScheme}>
    <!-- Skip to content link for accessibility -->
    <div class="skip-links">
      <a href="#main-content" class="skip-link wa-visually-hidden">
        <slot name="skip-to-content">Skip to content</slot>
      </a>
    </div>

    <!-- Mobile navigation toggle button (positioned at top-left of page) -->
    {showNav && (
    <wa-button class="mobile-nav-toggle" appearance="plain">
      <wa-icon name="bars" label="Toggle navigation"></wa-icon>
    </wa-button>
    )}

    <!-- Main page layout container -->
    <div class="page-layout" data-mobile-breakpoint={mobileBreakpoint} data-nav-open={navOpen}>

      <!-- Banner slot (optional) -->
      {Astro.slots.has('banner') && (
        <div class={`page-banner ${disableSticky.includes('banner') ? '' : 'sticky'}`}>
          <slot name="banner" />
        </div>
      )}

      <!-- Header slot -->
      {Astro.slots.has('header') && (
        <header class={`page-header ${disableSticky.includes('header') ? '' : 'sticky'}`}>
          <slot name="header" />
        </header>
      )}

      <!-- Subheader slot -->
      {Astro.slots.has('subheader') && (
        <div class={`page-subheader ${disableSticky.includes('subheader') ? '' : 'sticky'}`}>
          <slot name="subheader" />
        </div>
      )}

      <!-- Main body container -->
      <div class="page-body">

        <!-- Navigation menu -->
        {showNav && (Astro.slots.has('navigation') || Astro.slots.has('navigation-header') || Astro.slots.has('navigation-footer')) && (
          <>
            <!-- Desktop navigation -->
            <nav class={`page-menu ${disableSticky.includes('menu') ? '' : 'sticky'}`} data-view="desktop">
              {Astro.slots.has('navigation-header') && (
                <div class="navigation-header">
                  <slot name="navigation-header" />
                </div>
              )}

              <div class="navigation-content">
                <slot name="navigation" />
              </div>

              {Astro.slots.has('navigation-footer') && (
                <div class="navigation-footer">
                  <slot name="navigation-footer" />
                </div>
              )}
            </nav>

            <!-- Mobile navigation drawer -->
            <wa-drawer class="mobile-nav-drawer" placement="start" light-dismiss>
              {Astro.slots.has('navigation-header') && (
                <div class="navigation-header" slot="header">
                  <slot name="navigation-header" />
                </div>
              )}

              <div class="navigation-content">
                <slot name="navigation" />
              </div>

              {Astro.slots.has('navigation-footer') && (
                <div class="navigation-footer" slot="footer">
                  <slot name="navigation-footer" />
                </div>
              )}
            </wa-drawer>
          </>
        )}

        <!-- Main content area -->
        <main id="main-content" class="page-main">
          {Astro.slots.has('main-header') && (
            <div class="main-header">
              <slot name="main-header" />
            </div>
          )}

          <div class="main-content">
            <slot />
          </div>

          {Astro.slots.has('main-footer') && (
            <div class="main-footer">
              <slot name="main-footer" />
            </div>
          )}
        </main>

        <!-- Aside/sidebar -->
        {Astro.slots.has('aside') && (
          <aside class={`page-aside ${disableSticky.includes('aside') ? '' : 'sticky'}`}>
            <slot name="aside" />
          </aside>
        )}
      </div>

      <!-- Footer -->
      {Astro.slots.has('footer') && (
        <footer class="page-footer">
          <slot name="footer" />
        </footer>
      )}
    </div>

    <!-- Theme and navigation scripts -->
    <script>
            // Mobile navigation functionality
      const drawer = document.querySelector('.mobile-nav-drawer') as any;
      const toggleButton = document.querySelector<HTMLElement>('.mobile-nav-toggle');
      const pageLayout = document.querySelector('.page-layout') as HTMLElement;

      if (drawer && toggleButton) {
        toggleButton.addEventListener('click', () => {
          drawer.open = !drawer.open;
        });

        drawer.addEventListener('wa-hide', () => {
          pageLayout.setAttribute('data-nav-open', 'false');
        });

        drawer.addEventListener('wa-show', () => {
          pageLayout.setAttribute('data-nav-open', 'true');
        });
      }

      // Responsive behavior
      const mobileBreakpoint = pageLayout.getAttribute('data-mobile-breakpoint') || '768px';
      const mediaQuery = window.matchMedia(`(max-width: ${mobileBreakpoint})`);

      function handleViewportChange(e: MediaQueryList | MediaQueryListEvent) {
        const isMobile = e.matches;
        pageLayout.setAttribute('data-view', isMobile ? 'mobile' : 'desktop');

        // CSS now handles the display logic based on data-view attribute
        // No need to set inline styles that fight with CSS specificity
      }

      mediaQuery.addEventListener('change', handleViewportChange);
      handleViewportChange(mediaQuery);

      // Add fallback classes for browsers without :has() support
      const pageBody = document.querySelector('.page-body');
      const hasMenu = document.querySelector('.page-menu');
      const hasAside = document.querySelector('.page-aside');

      if (pageBody) {
        if (hasMenu) pageBody.classList.add('has-menu');
        if (hasAside) pageBody.classList.add('has-aside');
      }

      // Color scheme switching
      function setColorScheme(scheme: 'light' | 'dark' | 'auto') {
        localStorage.setItem('color-scheme', scheme);
        const isDark = scheme === 'dark' || (scheme === 'auto' && matchMedia('(prefers-color-scheme: dark)').matches);
        document.documentElement.classList.toggle('wa-dark', isDark);
        document.body.setAttribute('data-theme', scheme);
      }

      // Theme switching
      function setTheme(theme: string) {
        localStorage.setItem('theme', theme);

        // Remove existing theme classes
        document.documentElement.classList.remove(
          'wa-theme-awesome', 'wa-theme-shoelace'
        );

        if (theme !== 'default') {
          document.documentElement.classList.add(`wa-theme-${theme}`);
        }
      }

      // Expose functions globally for theme controls
      (window as any).setColorScheme = setColorScheme;
      (window as any).setTheme = setTheme;

      // Remove wa-cloak class once Web Awesome is loaded
      // This ensures proper theme rendering
      document.addEventListener('DOMContentLoaded', () => {
        // Wait for next frame to ensure Web Awesome has had time to initialize
        requestAnimationFrame(() => {
          document.documentElement.classList.remove('wa-cloak');
        });
      });
    </script>
  </body>
</html>

<style>
  /* Reset and base styles */
  html, body {
    min-height: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
    font-family: var(--wa-font-family-body);
    font-weight: var(--wa-font-weight-normal);
    color: var(--wa-color-text-normal);
    background-color: var(--wa-color-surface-default);
  }

  /* Typography */
  h1, h2, h3, h4, h5, h6 {
    font-family: var(--wa-font-family-heading);
    font-weight: var(--wa-font-weight-bold);
    color: var(--wa-color-text-normal);
  }

  code {
    font-family: var(--wa-font-family-code);
  }

  a {
    text-decoration: var(--wa-link-decoration-default);
    color: var(--wa-color-text-link);
  }

  a:hover {
    text-decoration: var(--wa-link-decoration-hover);
  }

  /* Skip links */
  .skip-links {
    position: relative;
    z-index: 1000;
  }

  .skip-link {
    position: absolute;
    top: var(--wa-space-s);
    left: var(--wa-space-s);
    padding: var(--wa-space-xs) var(--wa-space-s);
    background-color: var(--wa-color-brand-fill-loud);
    color: var(--wa-color-brand-on-loud);
    border-radius: var(--wa-border-radius-m);
    text-decoration: none;
    font-weight: var(--wa-font-weight-semibold);
    z-index: 1001;
  }

  .skip-link:focus {
    position: absolute;
    clip: auto;
    width: auto;
    height: auto;
  }

  /* Main page layout */
  .page-layout {
    display: grid !important;
    grid-template-rows: auto auto auto 1fr auto;
    grid-template-areas:
      "banner"
      "header"
      "subheader"
      "body"
      "footer";
    min-height: 100vh;
  }

  /* Banner */
  .page-banner {
    grid-area: banner;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: var(--wa-space-s) var(--wa-space-m);
    background-color: var(--wa-color-surface-raised);
    border-bottom: 1px solid var(--wa-color-surface-border);
  }

  .page-banner.sticky {
    position: sticky;
    top: 0;
    z-index: 100;
  }

  /* Header */
  .page-header {
    grid-area: header;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--wa-space-s);
    padding: var(--wa-space-m);
    background-color: var(--wa-color-surface-default);
    border-bottom: 1px solid var(--wa-color-surface-border);
  }

  .page-header.sticky {
    position: sticky;
    top: 0;
    z-index: 99;
  }

  /* Subheader */
  .page-subheader {
    grid-area: subheader;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--wa-space-s);
    padding: var(--wa-space-s) var(--wa-space-m);
    background-color: var(--wa-color-surface-lowered);
    border-bottom: 1px solid var(--wa-color-surface-border);
  }

  .page-subheader.sticky {
    position: sticky;
    top: var(--header-height, 0);
    z-index: 98;
  }

  /* Body container */
  .page-body {
    grid-area: body;
    display: grid;
    grid-template-columns: 0 1fr 0;
    grid-template-areas: "menu main aside";
    min-height: 0;
    gap: 0;
    width: 100%;
    max-width: 100%;
  }

  /* Mobile navigation toggle is positioned at top-left of page */
  .mobile-nav-toggle {
    position: fixed;
    top: var(--wa-space-s);
    left: var(--wa-space-s);
    z-index: 1001; /* Higher than header sticky z-index */
    display: none;
  }

  /* Make the hamburger (bars) icon larger inside the mobile toggle */
  .mobile-nav-toggle wa-icon {
    font-size: 1.7rem; /* increase icon size */
    width: 1.7rem;
    height: 1.7rem;
    line-height: 1; /* avoid extra vertical space */
  }

  /* Hide hamburger on desktop - only show on mobile */
  @media (min-width: 769px) {
    .mobile-nav-toggle {
      display: none !important;
    }
  }

  /* Dynamic grid layout based on content presence */
  .page-body:not(:has(.page-menu)):not(:has(.page-aside)) {
    grid-template-columns: 1fr;
    grid-template-areas: "main";
  }

  .page-body:has(.page-menu):not(:has(.page-aside)) {
    grid-template-columns: var(--menu-width, 15rem) 1fr;
    grid-template-areas: "menu main";
  }

  .page-body:not(:has(.page-menu)):has(.page-aside) {
    grid-template-columns: 1fr var(--aside-width, 15rem);
    grid-template-areas: "main aside";
  }

  .page-body:has(.page-menu):has(.page-aside) {
    grid-template-columns: var(--menu-width, 15rem) 1fr var(--aside-width, 15rem);
    grid-template-areas: "menu main aside";
  }

  /* Fallback for browsers without :has() support */
  @supports not (selector(:has(*))) {
    .page-body {
      grid-template-columns: 1fr;
      grid-template-areas: "main";
    }

    .page-body.has-menu {
      grid-template-columns: 15rem 1fr;
      grid-template-areas: "menu main";
    }

    .page-body.has-aside {
      grid-template-columns: 1fr 15rem;
      grid-template-areas: "main aside";
    }

    .page-body.has-menu.has-aside {
      grid-template-columns: 15rem 1fr 15rem;
      grid-template-areas: "menu main aside";
    }
  }

  /* Override :has() with explicit classes for more reliable behavior */
  .page-body.has-menu {
    grid-template-columns: 15rem 1fr !important;
    grid-template-areas: "menu main" !important;
  }

  .page-body.has-aside {
    grid-template-columns: 1fr 15rem !important;
    grid-template-areas: "main aside" !important;
  }

  .page-body.has-menu.has-aside {
    grid-template-columns: 15rem 1fr 15rem !important;
    grid-template-areas: "menu main aside" !important;
  }

  /* Navigation menu */
  .page-menu {
    grid-area: menu;
    display: flex;
    flex-direction: column;
    min-width: var(--menu-width, 15rem);
    width: 100%;
    background-color: var(--wa-color-surface-lowered);
    border-right: 1px solid var(--wa-color-surface-border);
    overflow-y: auto;
  }

  .page-menu.sticky {
    position: sticky;
    top: var(--sticky-top, 0);
    height: calc(100vh - var(--sticky-top, 0));
  }

  .navigation-header,
  .navigation-footer {
    padding: var(--wa-space-m);
    border-bottom: 1px solid var(--wa-color-surface-border);
  }

  .navigation-footer {
    border-bottom: none;
    border-top: 1px solid var(--wa-color-surface-border);
    margin-top: auto;
  }

  .navigation-content {
    flex: 1;
    padding: var(--wa-space-m);
    overflow-y: auto;
  }

  /* Mobile navigation */
  .mobile-nav-drawer {
    --size: 280px;
  }

  .mobile-nav-toggle {
    justify-self: start;
    align-self: center;
    z-index: 1000;
    display: none;
    margin: var(--wa-space-s) var(--wa-space-m);
    width: fit-content;
  }

  /* Main content */
  .page-main {
    grid-area: main;
    display: flex;
    flex-direction: column;
    min-width: 0;
    width: 100%;
    max-width: 100%;
    padding: var(--wa-space-l);
    overflow-x: hidden;
  }

  .main-header,
  .main-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--wa-space-s);
    padding: var(--wa-space-m) 0;
  }

  .main-footer {
    border-top: 1px solid var(--wa-color-surface-border);
    margin-top: auto;
  }

  .main-content {
    flex: 1;
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
    word-wrap: break-word;
  }

  /* Aside/sidebar */
  .page-aside {
    grid-area: aside;
    display: flex;
    flex-direction: column;
    min-width: var(--aside-width, 15rem);
    width: 100%;
    padding: var(--wa-space-l);
    background-color: var(--wa-color-surface-lowered);
    border-left: 1px solid var(--wa-color-surface-border);
    overflow-y: auto;
  }

  .page-aside.sticky {
    position: sticky;
    top: var(--sticky-top, 0);
    height: calc(100vh - var(--sticky-top, 0));
  }

  /* Footer */
  .page-footer {
    grid-area: footer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--wa-space-s);
    padding: var(--wa-space-l);
    background-color: var(--wa-color-surface-lowered);
    border-top: 1px solid var(--wa-color-surface-border);
  }

  /* Responsive behavior */
  @media (max-width: 768px) {
    .page-body,
    .page-body.has-menu,
    .page-body.has-aside,
    .page-body.has-menu.has-aside {
      grid-template-columns: 1fr !important;
      grid-template-areas: "main" !important;
    }

    /* Removed global aside hide to allow mobile TOC in component override pages */

    /* Use data-view attribute for responsive navigation control */
    .page-layout[data-view="mobile"] .page-menu[data-view="desktop"] {
      display: none !important;
    }

    .page-main {
      padding: var(--wa-space-m);
    }

    /* Use data-view attribute for responsive hamburger control */
    .page-layout[data-view="mobile"] .mobile-nav-toggle {
      display: block !important;
    }

    /* Add padding to header content to avoid overlap with hamburger */
    .page-header {
      padding-left: calc(var(--wa-space-s) + 43px + var(--wa-space-s) + var(--wa-space-m));
    }

    .page-banner {
      padding-left: calc(var(--wa-space-s) + 43px + var(--wa-space-s) + var(--wa-space-m));
    }
  }

  /* Desktop view - ensure navigation is visible */
  .page-layout[data-view="desktop"] .page-menu[data-view="desktop"] {
    display: flex;
  }

  /* Desktop view - ensure hamburger is hidden */
  .page-layout[data-view="desktop"] .mobile-nav-toggle {
    display: none !important;
  }

  /* Additional responsive behavior for layouts that need to collapse at 920px */
  @media (max-width: 920px) {
    /* Default: collapse to single column when there is no left menu */
    .page-body.collapse-aside-920 {
      grid-template-columns: 1fr !important;
      grid-template-areas: "main" !important;
    }

    /* Keep the left navigation visible and in the left column when present,
       while collapsing the aside at <=920px. This prevents the nav from
       auto-placing to the bottom/right when the grid only defines "main". */
    .page-body.collapse-aside-920.has-menu {
      grid-template-columns: var(--menu-width, 15rem) 1fr !important;
      grid-template-areas: "menu main" !important;
    }

    /* Removed aside display:none here; handled by DocsLayout when needed */
  }

  /* Additional rule for mobile-only hamburger at 768px */
  @media (max-width: 768px) {
    /* Forcefully collapse all grid variants to a single column on small screens,
       including the 920px collapse variant with a menu to avoid left whitespace */
    .page-body.collapse-aside-920.has-menu,
    .page-body.collapse-aside-920,
    .page-body.has-menu.has-aside,
    .page-body.has-aside,
    .page-body.has-menu,
    .page-body {
      grid-template-columns: 1fr !important;
      grid-template-areas: "main" !important;
    }

    /* Hide the desktop menu in mobile view to reclaim the space */
    .page-layout[data-view="mobile"] .page-menu[data-view="desktop"] {
      display: none !important;
    }

    .mobile-nav-toggle {
      display: block !important;
    }
  }

  /* Custom properties for layout customization */
  :root {
    --menu-width: 0;
    --main-width: 1fr;
    --aside-width: 0;
    --header-height: 0px;
    --subheader-height: 0px;
    --banner-height: 0px;
    --sticky-top: calc(var(--banner-height) + var(--header-height) + var(--subheader-height));
  }

  /* Layout when navigation is present */
  .page-layout:has(.page-menu) {
    --menu-width: 15rem;
  }

  /* Layout when aside is present */
  .page-layout:has(.page-aside) {
    --aside-width: 15rem;
  }

  /* Explicit class-based approach for layout control */
  .page-body.has-menu {
    --menu-width: 15rem;
  }

  .page-body.has-aside {
    --aside-width: 15rem;
  }

  /* Utility classes */
  [data-mobile-only] {
    display: none;
  }

  @media (max-width: 768px) {
    [data-mobile-only] {
      display: block;
    }

    [data-desktop-only] {
      display: none;
    }
  }

  /* Theme-specific adjustments */
  .wa-dark {
    color-scheme: dark;
  }

  /* Focus management */
  :focus-visible {
    outline: var(--wa-focus-ring);
    outline-offset: var(--wa-focus-ring-offset);
  }
</style>

<!-- Web Awesome component definitions -->
<script>
  import '@awesome.me/webawesome/dist/components/button/button.js';
  import '@awesome.me/webawesome/dist/components/drawer/drawer.js';
  import '@awesome.me/webawesome/dist/components/icon/icon.js';
</script>